============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-8.3.4, pluggy-1.5.0 -- C:\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\cabra\Projects\LifeOS
configfile: pytest.ini
plugins: anyio-4.7.0, asyncio-1.3.0, cov-6.2.1, mockito-0.0.4
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 6 items

runtime/tests/orchestration/missions/test_loop_acceptance.py::test_crash_and_resume PASSED [ 16%]
runtime/tests/orchestration/missions/test_loop_acceptance.py::test_acceptance_oscillation PASSED [ 33%]
runtime/tests/orchestration/missions/test_loop_acceptance.py::test_verify_terminal_packet_structure PASSED [ 50%]
runtime/tests/orchestration/missions/test_loop_acceptance.py::test_diff_budget_exceeded FAILED [ 66%]
runtime/tests/orchestration/missions/test_loop_acceptance.py::test_policy_changed_mid_run PASSED [ 83%]
runtime/tests/orchestration/missions/test_loop_acceptance.py::test_workspace_reset_unavailable PASSED [100%]

================================== FAILURES ===================================
__________________________ test_diff_budget_exceeded __________________________

acceptance_context = MissionContext(repo_root=WindowsPath('C:/Users/cabra/AppData/Local/Temp/pytest-of-cabra/pytest-630/test_diff_budget_exceeded0/repo'), baseline_commit='abc', run_id='acc_run', operation_executor=None, journal=None, metadata={})
mock_subs = (<MagicMock name='DesignMission' id='1866523606672'>, <MagicMock name='BuildMission' id='1866523629408'>, <MagicMock name='ReviewMission' id='1866523633248'>, <MagicMock name='StewardMission' id='1866523637088'>)

    def test_diff_budget_exceeded(acceptance_context, mock_subs):
        D, B, R, S = mock_subs
        # Mock approval to get to build
        D.return_value.run.return_value = MissionResult(True, MissionType.DESIGN, outputs={"build_packet": {"goal":"g"}}, evidence={"usage":{"total":1}})
        R.return_value.run.side_effect = mock_review_behavior # Approve Design
    
        # Create massive diff (301 lines)
        massive_diff = "\n".join([f"line {i}" for i in range(301)])
    
        B.return_value.run.return_value = MissionResult(True, MissionType.BUILD, outputs={"review_packet": {"payload": {"content": massive_diff}}}, evidence={"usage":{"total":1}})
    
        mission = AutonomousBuildCycleMission()
        result = mission.run(acceptance_context, {"task_spec": "diff_limit"})
    
        assert result.success is False
>       assert result.escalation_reason == TerminalReason.DIFF_BUDGET_EXCEEDED.value
E       AssertionError: assert None == 'diff_budget_exceeded'
E        +  where None = MissionResult(success=False, mission_type=<MissionType.AUTONOMOUS_BUILD_CYCLE: 'autonomous_build_cycle'>, outputs={}, executed_steps=[], error='no_progress', escalation_reason=None, evidence={}).escalation_reason
E        +  and   'diff_budget_exceeded' = <TerminalReason.DIFF_BUDGET_EXCEEDED: 'diff_budget_exceeded'>.value
E        +    where <TerminalReason.DIFF_BUDGET_EXCEEDED: 'diff_budget_exceeded'> = TerminalReason.DIFF_BUDGET_EXCEEDED

runtime\tests\orchestration\missions\test_loop_acceptance.py:168: AssertionError
=========================== short test summary info ===========================
FAILED runtime/tests/orchestration/missions/test_loop_acceptance.py::test_diff_budget_exceeded - AssertionError: assert None == 'diff_budget_exceeded'
 +  where None = MissionResult(success=False, mission_type=<MissionType.AUTONOMOUS_BUILD_CYCLE: 'autonomous_build_cycle'>, outputs={}, executed_steps=[], error='no_progress', escalation_reason=None, evidence={}).escalation_reason
 +  and   'diff_budget_exceeded' = <TerminalReason.DIFF_BUDGET_EXCEEDED: 'diff_budget_exceeded'>.value
 +    where <TerminalReason.DIFF_BUDGET_EXCEEDED: 'diff_budget_exceeded'> = TerminalReason.DIFF_BUDGET_EXCEEDED
========================= 1 failed, 5 passed in 1.12s =========================
