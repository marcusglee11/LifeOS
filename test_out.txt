============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-8.3.4, pluggy-1.5.0 -- C:\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\cabra\Projects\LifeOS
configfile: pytest.ini
plugins: anyio-4.7.0, asyncio-1.3.0, cov-6.2.1, mockito-0.0.4
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 4 items / 3 deselected / 1 selected

runtime/tests/orchestration/missions/test_autonomous_loop.py::test_budget_exhausted FAILED [100%]

================================== FAILURES ===================================
____________________________ test_budget_exhausted ____________________________

mock_context = MissionContext(repo_root=WindowsPath('C:/Users/cabra/AppData/Local/Temp/pytest-of-cabra/pytest-622/test_budget_exhausted0/repo'), baseline_commit='abc', run_id='test_run', operation_executor=None, journal=None, metadata={})
mock_sub_missions = (<MagicMock name='DesignMission' id='1728569030944'>, <MagicMock name='BuildMission' id='1728569321680'>, <MagicMock name='ReviewMission' id='1728569325520'>, <MagicMock name='StewardMission' id='1728569492640'>)

    def test_budget_exhausted(mock_context, mock_sub_missions):
        _, _, MockReview, _ = mock_sub_missions
        # Make Review reject everything -> Loop -> Exhaust Budget
        r_inst = MockReview.return_value
        # First call is Design Review (Approved), subsequent are Output Review (Rejected)
    
        # We need side_effect to distinguish calls?
        # Or just make all reviews reject?
        # If Design Review rejects, we exit 'Design rejected'.
        # We want Design Approved, Loop Rejected.
    
        def review_side_effect(ctx, inp):
            if inp["review_type"] == "build_review":
                return MissionResult(True, MissionType.REVIEW, outputs={"verdict": "approved"}, evidence={"usage":{"total":1}})
            else:
                return MissionResult(True, MissionType.REVIEW, outputs={"verdict": "rejected"}, evidence={"usage":{"total":1}})
    
        r_inst.run.side_effect = review_side_effect
    
        mission = AutonomousBuildCycleMission()
        inputs = {"task_spec": "loop forever"}
    
        # Mock budget to be small (hard to mock internals, but we can rely on default loop limit 5)
        # It should loop 5 times then fail.
    
        result = mission.run(mock_context, inputs)
    
        assert result.success is False
>       assert result.error == TerminalReason.BUDGET_EXHAUSTED.value
E       AssertionError: assert 'no_progress' == 'budget_exhausted'
E         
E         - budget_exhausted
E         + no_progress

runtime\tests\orchestration\missions\test_autonomous_loop.py:103: AssertionError
=========================== short test summary info ===========================
FAILED runtime/tests/orchestration/missions/test_autonomous_loop.py::test_budget_exhausted
======================= 1 failed, 3 deselected in 1.09s =======================
