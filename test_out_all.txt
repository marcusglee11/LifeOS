============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-8.3.4, pluggy-1.5.0 -- C:\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\cabra\Projects\LifeOS
configfile: pytest.ini
plugins: anyio-4.7.0, asyncio-1.3.0, cov-6.2.1, mockito-0.0.4
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 4 items

runtime/tests/orchestration/missions/test_autonomous_loop.py::test_loop_happy_path PASSED [ 25%]
runtime/tests/orchestration/missions/test_autonomous_loop.py::test_token_accounting_fail_closed PASSED [ 50%]
runtime/tests/orchestration/missions/test_autonomous_loop.py::test_budget_exhausted PASSED [ 75%]
runtime/tests/orchestration/missions/test_autonomous_loop.py::test_resume_policy_check FAILED [100%]

================================== FAILURES ===================================
__________________________ test_resume_policy_check ___________________________

mock_context = MissionContext(repo_root=WindowsPath('C:/Users/cabra/AppData/Local/Temp/pytest-of-cabra/pytest-625/test_resume_policy_check0/repo'), baseline_commit='abc', run_id='test_run', operation_executor=None, journal=None, metadata={})
mock_sub_missions = (<MagicMock name='DesignMission' id='1875942652048'>, <MagicMock name='BuildMission' id='1875942701488'>, <MagicMock name='ReviewMission' id='1875942754544'>, <MagicMock name='StewardMission' id='1875942693808'>)

    def test_resume_policy_check(mock_context, mock_sub_missions):
        # PLANT A LEDGER WITH DIFFERENT POLICY HASH
        ledger_path = mock_context.repo_root / "artifacts/loop_state/attempt_ledger.jsonl"
        with open(ledger_path, "w") as f:
            f.write('{"type": "header", "policy_hash": "BOGUS", "handoff_hash": "X", "run_id": "r"}\n')
            f.write('{"attempt_id": 1, "success": false}\n') # dummy record
    
        mission = AutonomousBuildCycleMission()
        inputs = {"task_spec": "resume"}
    
        result = mission.run(mock_context, inputs)
    
        assert result.success is False
>       assert TerminalReason.POLICY_CHANGED_MID_RUN.value in result.escalation_reason
E       TypeError: argument of type 'NoneType' is not iterable

runtime\tests\orchestration\missions\test_autonomous_loop.py:121: TypeError
=========================== short test summary info ===========================
FAILED runtime/tests/orchestration/missions/test_autonomous_loop.py::test_resume_policy_check
========================= 1 failed, 3 passed in 1.10s =========================
